<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>InsightAudio ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—è</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', path='favicon.ico') }}">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f4f6f8; color: #333; }
        .container { max-width: 700px; margin: auto; background: #fff; padding: 32px 40px; border-radius: 12px; box-shadow: 0 2px 10px #aaa2; }
        h1 { color: #0059b2; }
        label { font-weight: 700; margin: 12px 0 6px 0; display: block;}
        select, input[type="file"] { margin-bottom: 20px; }
        button { background: #0059b2; color: #fff; border: none; padding: 12px 28px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #aaa; }
        .models-section { margin-bottom: 16px; border: 1px solid #ddd; padding: 12px; border-radius: 8px; background: #fafbfc; }
        .status { font-size: 13px; color: #009100; margin-left: 8px; }
        .status.notdownloaded { color: #a00; }
        .small { font-size: 12px; color: #555; }
        #progress-bar { width: 100%; background: #eee; height: 8px; border-radius: 4px; margin: 12px 0; display:none;}
        #progress-value { background: #0059b2; height: 8px; border-radius: 4px; width:0%; transition: width 0.3s;}
        .progress-info { font-size: 12px; color: #666; margin-top: 4px; display: none;}
        .progress-info.active { display: block;}
        .notify { padding: 10px; border-radius:5px; color: #fff; background: #38a; margin:10px 0; display:none; position: relative;}
        .notify.error { background: #c00; }
        .notify .copy-btn { position: absolute; right: 30px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; color: #fff; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; z-index: 10;}
        .notify .copy-btn:hover { background: rgba(255,255,255,0.5); }
        .notify .close-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.3); border: none; color: #fff; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; z-index: 10;}
        .notify .close-btn:hover { background: rgba(255,255,255,0.5); }
        .download-btn { background: #e09000; color: #fff; padding: 6px 16px; border-radius: 6px; font-size: 13px; margin:0 10px; cursor: pointer;}
        .download-btn:disabled { background: #aaa; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>InsightAudio</h1>
        <div class="tabs">
            <button class="tab-btn active" data-tab="audioTab" onclick="switchTab('audioTab')">Audio</button>
            <button class="tab-btn" data-tab="docTab" onclick="switchTab('docTab')">Documents</button>
            <button class="tab-btn" data-tab="jobsTab" onclick="switchTab('jobsTab')">My Jobs</button>
        </div>

        <div class="notify" id="notify"></div>

        <section id="audioTab" class="tab-section">
            <h2>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ</h2>
            <form id="processForm">
                <label for="file">–§–∞–π–ª (–∞—É–¥–∏–æ/–≤–∏–¥–µ–æ):</label>
                <input type="file" name="file" id="file" required accept="audio/*,video/*">

                <div class="models-section">
                    <label for="transcribe_model">–ú–æ–¥–µ–ª—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select name="transcribe_model" id="transcribe_model" required style="flex: 1;">
                        {% for model in model_options.transcribe %}
                                <option value="{{model.name}}" data-downloaded="{{ 'true' if model.downloaded else 'false' }}">
                                {{model.display_name}}
                                {% if model.downloaded %}
                                    (—Å–∫–∞—á–∞–Ω–æ)
                                {% else %}
                                    (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                        <button class="download-btn" type="button" id="transcribe_download_btn" style="display: none;" onclick="downloadSelectedModel('transcribe')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <label for="asr_engine">–î–≤–∏–∂–æ–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</label>
                    <select id="asr_engine">
                        <option value="auto">Auto (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è faster-whisper)</option>
                        <option value="faster_whisper">Faster-Whisper üü© Recommended</option>
                        <option value="openai_whisper">OpenAI Whisper üü® Legacy</option>
                    </select>
                    <div class="small" id="asr_engine_hint">Auto –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –ª—É—á—à–∏–π –¥–≤–∏–∂–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏</div>
                </div>

                <div class="models-section">
                    <label for="audio_language">–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:</label>
                    <select id="audio_language">
                        <option value="auto">–ê–≤—Ç–æ</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="it">Italiano</option>
                    </select>
                    <label for="preset">–ü—Ä–µ—Å–µ—Ç –∫–∞—á–µ—Å—Ç–≤–∞:</label>
                    <select id="preset">
                        <option value="quality">Quality (beam=5, vad, loudnorm)</option>
                        <option value="balanced" selected>Balanced (beam=3, vad, loudnorm)</option>
                        <option value="fast">Fast (beam=1, vad, no loudnorm)</option>
                    </select>
                    <label><input type="checkbox" id="enable_diarization" checked> –î–∏–∞—Ä–∏–∑–∞—Ü–∏—è</label>
                </div>

                <div class="models-section">
                    <details>
                        <summary>Advanced ASR</summary>
                        <label for="beam_size">beam_size</label>
                        <input type="number" id="beam_size" min="1" max="10" step="1" placeholder="auto">
                        <label for="temperature">temperature</label>
                        <input type="number" id="temperature" min="0" max="1" step="0.1" placeholder="auto">
                        <label for="vad_filter">VAD filter <span id="vad_filter_badge" style="font-size: 11px; color: #666;"></span></label>
                        <select id="vad_filter" disabled>
                            <option value="">auto</option>
                            <option value="true">on</option>
                            <option value="false">off</option>
                        </select>
                        <div class="small" id="vad_filter_hint" style="color: #666;">–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è faster-whisper</div>
                        <label for="no_speech_threshold">no_speech_threshold</label>
                        <input type="number" id="no_speech_threshold" min="0" max="1" step="0.05" placeholder="auto">
                    </details>
                </div>

                <div class="models-section">
                    <label><input type="checkbox" id="enable_summary" checked> –°–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ—Å–∫–∞–∑ (summary)</label>
                </div>

                <div id="summary_blocks" class="models-section">
                    <label for="summary_backend_selector">–ò—Å—Ç–æ—á–Ω–∏–∫ –º–æ–¥–µ–ª–µ–π –ø–µ—Ä–µ—Å–∫–∞–∑–∞:</label>
                    <select id="summary_backend_selector">
                        <option value="ollama">Ollama ({{config.OLLAMA_API_BASE}})</option>
                        <option value="llama_cpp">llama.cpp</option>
                        <option value="custom_api">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ API</option>
                    </select>
                    <div class="small">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø–µ—Ä–µ—Å–∫–∞–∑–∞.</div>
                </div>

                <div class="models-section" id="custom_api_block" style="display:none;">
                    <label for="custom_api_url">URL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ API:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="custom_api_url" placeholder="https://example.com/summary-endpoint" style="flex: 1;">
                        <button type="button" id="check_custom_api_btn" class="btn" onclick="checkCustomApi('summarize')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                    </div>
                    <div class="small" id="custom_api_status"></div>
                    <div id="custom_api_manual_models" style="display:none; margin-top: 10px;">
                        <label for="custom_api_models_manual">–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <input type="text" id="custom_api_models_manual" placeholder="model1,model2,model3" style="width: 100%;">
                        <div class="small">–£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª–∏ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</div>
                    </div>
                </div>

                <div id="summary_model_block" class="models-section">
                    <label for="summarize_model">–ú–æ–¥–µ–ª—å –ø–µ—Ä–µ—Å–∫–∞–∑–∞ (summary):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select name="summarize_model" id="summarize_model" required style="flex: 1;">
                        {% for model in model_options.summarize %}
                                <option value="{{model.name}}" data-downloaded="{{ 'true' if model.downloaded else 'false' }}"
                                    {% if model.metrics %}data-metrics='{{ model.metrics | tojson | safe }}'{% endif %}
                                    {% if model.metrics_summary %}data-metrics-summary="{{ model.metrics_summary }}"{% endif %}>
                                {{model.display_name}}
                                {% if model.downloaded %}
                                    (—Å–∫–∞—á–∞–Ω–æ)
                                {% else %}
                                    (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)
                                {% endif %}
                                    {% if model.metrics_summary %}
                                        ‚Äî {{ model.metrics_summary }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                        <button class="download-btn" type="button" id="summarize_download_btn" style="display: none;" onclick="downloadSelectedModel('summarize')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <div class="small" id="summary_metrics_hint">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏.</div>
                </div>

                <div id="review_model_block" class="models-section">
                    <label for="review_model">–ú–æ–¥–µ–ª—å –¥–ª—è —Ä–µ–≤—å—é –ø–µ—Ä–µ—Å–∫–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select name="review_model" id="review_model" style="flex: 1;">
                            <option value="">‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî</option>
                        {% for model in model_options.summarize %}
                                <option value="{{model.name}}" data-downloaded="{{ 'true' if model.downloaded else 'false' }}"
                                    {% if model.metrics %}data-metrics='{{ model.metrics | tojson | safe }}'{% endif %}
                                    {% if model.metrics_summary %}data-metrics-summary="{{ model.metrics_summary }}"{% endif %}>
                                {{model.display_name}}
                                {% if model.downloaded %}
                                    (—Å–∫–∞—á–∞–Ω–æ)
                                {% else %}
                                    (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)
                                {% endif %}
                                    {% if model.metrics_summary %}
                                        ‚Äî {{ model.metrics_summary }}
                                {% endif %}
                            </option>
                        {% endfor %}
                    </select>
                        <button class="download-btn" type="button" id="review_download_btn" style="display: none;" onclick="downloadSelectedModel('review')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <div class="small">–ú–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø–µ—Ä–µ—Å–∫–∞–∑–∞ –ø–æ—Å–ª–µ –µ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</div>
                </div>

                <div id="review_prompt_block" class="models-section" style="display:none;">
                    <label for="review_prompt_template">–®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ä–µ–≤—å—é:</label>
                    <select id="review_prompt_template">
                        <option value="">‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π ‚Äî</option>
                        {% for tpl in config.PROMPT_TEMPLATES %}
                        <option value="{{ tpl.id }}" data-text="{{ tpl.prompt_text|e }}">{{ tpl.title }} ‚Äî {{ tpl.description }}</option>
                        {% endfor %}
                    </select>
                    <label for="review_custom_prompt">–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ–≤—å—é –ø–µ—Ä–µ—Å–∫–∞–∑–∞:</label>
                    <textarea id="review_custom_prompt" rows="5" placeholder="–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è –ø–µ—Ä–µ—Å–∫–∞–∑–∞"></textarea>
                    <div class="small">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.</div>
                </div>

                <div id="prompt_template_block" class="models-section">
                    <label for="prompt_template">–®–∞–±–ª–æ–Ω –ø—Ä–æ–º–ø—Ç–∞:</label>
                    <select id="prompt_template">
                        <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
                        {% for tpl in config.PROMPT_TEMPLATES %}
                        <option value="{{ tpl.id }}" data-text="{{ tpl.prompt_text|e }}">{{ tpl.title }} ‚Äî {{ tpl.description }}</option>
                        {% endfor %}
                    </select>
                    <label for="custom_prompt">–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—É—Å–∫–∞:</label>
                    <textarea id="custom_prompt" rows="5" placeholder="–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞"></textarea>
                </div>

                <div class="models-section">
                    <label><input type="checkbox" id="enable_translation"> –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</label>
                    <label for="target_language_audio">–¶–µ–ª–µ–≤–æ–π —è–∑—ã–∫:</label>
                    <select id="target_language_audio">
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="en">English</option>
                        <option value="de">Deutsch</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </div>

                <div id="progress-bar"><div id="progress-value"></div></div>
                <div class="progress-info" id="progress-info"></div>
                <button type="submit" id="processBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å</button>
            </form>
            <div id="audioJobStatus" class="job-status"></div>
        </section>

        <section id="docTab" class="tab-section" style="display:none;">
            <h2>–ü–µ—Ä–µ–≤–æ–¥ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
            <form id="translateForm">
                <label for="doc_file">–î–æ–∫—É–º–µ–Ω—Ç (DOCX, PPTX, XLSX, PDF):</label>
                <input type="file" name="file" id="doc_file" required accept=".docx,.pptx,.xlsx,.pdf">

                <label for="target_language">–Ø–∑—ã–∫ –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                <select name="target_language" id="target_language">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                    <option value="de">Deutsch</option>
                    <option value="es">Espa√±ol</option>
                </select>

                <div class="models-section">
                    <label for="translate_backend_selector">–ò—Å—Ç–æ—á–Ω–∏–∫ –º–æ–¥–µ–ª–µ–π –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                    <select id="translate_backend_selector">
                        <option value="ollama">Ollama ({{config.OLLAMA_API_BASE}})</option>
                        <option value="llama_cpp">llama.cpp</option>
                        <option value="custom_api">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ API</option>
                    </select>
                    <div class="small">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ –∏ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –ø–µ—Ä–µ–≤–æ–¥–∞.</div>
                </div>

                <div class="models-section" id="translate_custom_api_block" style="display:none;">
                    <label for="translate_custom_api_url">URL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ API:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="translate_custom_api_url" placeholder="https://example.com/translate-endpoint" style="flex: 1;">
                        <button type="button" id="check_translate_custom_api_btn" class="btn" onclick="checkCustomApi('translate')">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
                    </div>
                    <div class="small" id="translate_custom_api_status"></div>
                    <div id="translate_custom_api_manual_models" style="display:none; margin-top: 10px;">
                        <label for="translate_custom_api_models_manual">–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</label>
                        <input type="text" id="translate_custom_api_models_manual" placeholder="model1,model2,model3" style="width: 100%;">
                        <div class="small">–£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª–∏ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å</div>
                    </div>
                </div>

                <div class="models-section">
                    <label for="translate_model">–ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select name="translate_model" id="translate_model" required style="flex: 1;">
                            {% for model in model_options.translate %}
                                <option value="{{model.name}}" data-downloaded="{{ 'true' if model.downloaded else 'false' }}"
                                    {% if model.metrics %}data-metrics='{{ model.metrics | tojson | safe }}'{% endif %}
                                    {% if model.metrics_summary %}data-metrics-summary="{{ model.metrics_summary }}"{% endif %}>
                                    {{model.display_name}}
                                    {% if model.downloaded %}
                                        (—Å–∫–∞—á–∞–Ω–æ)
                                    {% else %}
                                        (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)
                                    {% endif %}
                                    {% if model.metrics_summary %}
                                        ‚Äî {{ model.metrics_summary }}
                                    {% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        <button class="download-btn" type="button" id="translate_download_btn" style="display: none;" onclick="downloadSelectedModel('translate')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <div class="small" id="translate_metrics_hint">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏.</div>
                </div>
                <div class="models-section">
                    <label for="translation_mode">–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:</label>
                    <select name="translation_mode" id="translation_mode">
                        <option value="block" {% if config.DEFAULT_TRANSLATION_MODE == "block" %}selected{% endif %}>–ë–ª–æ—á–Ω—ã–π —Ä–µ–∂–∏–º ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
                        <option value="full" {% if config.DEFAULT_TRANSLATION_MODE == "full" %}selected{% endif %}>–ï–¥–∏–Ω—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –º–µ–Ω—å—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ –º–æ–¥–µ–ª–∏</option>
                    </select>
                    <div class="small">–†–µ–∂–∏–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ DOCX/PPTX/XLSX. –î–ª—è PDF –ø–æ–∫–∞ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–ª–æ—á–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥.</div>
                </div>
                <div class="models-section">
                    <label><input type="checkbox" name="pdf_reflow" id="pdf_reflow" {% if config.DEFAULT_PDF_REFLOW %}checked{% endif %}> –ü–µ—Ä–µ–≤–æ–¥ PDF —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –º–∞–∫–µ—Ç–∞</label>
                    <div class="small">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–µ–∫—Å—Ç –≤ PDF –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ.</div>
                    <label for="image_translation_mode">–ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö:</label>
                    <select name="image_translation_mode" id="image_translation_mode">
                        <option value="notes" {% if config.DEFAULT_IMAGE_TRANSLATION_MODE == "notes" %}selected{% endif %}>–ò–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–º–µ—Ç–∫–∏</option>
                        <option value="redesign" {% if config.DEFAULT_IMAGE_TRANSLATION_MODE == "redesign" %}selected{% endif %}>–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø–µ—Ä–µ–≤–æ–¥–æ–º</option>
                    </select>
                </div>
                <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å</button>
            </form>
            <div id="docJobStatus" class="job-status"></div>
        </section>

        <section id="jobsTab" class="tab-section" style="display:none;">
            <h2>–ú–æ–∏ –∑–∞–¥–∞–Ω–∏—è</h2>
            <button class="btn" type="button" onclick="loadJobs()">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <div id="jobsList" class="job-list"></div>
        </section>

        <div class="small" style="margin-top:28px;">
            <b>–ö–∞—Ç–∞–ª–æ–≥ –º–æ–¥–µ–ª–µ–π:</b> {{config.MODEL_DIR}}<br>
            <b>–ö–∞—Ç–∞–ª–æ–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤/config:</b> {{config.CONFIG_DIR}}<br>
            <b>Ollama API:</b> {{config.OLLAMA_API_BASE}}<br>
            –í—Å–µ –º–æ–¥–µ–ª–∏ –º–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏–ª–∏ —á–µ—Ä–µ–∑ ollama/pip/huggingface –≤—Ä—É—á–Ω—É—é –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥.
        </div>
    </div>

    <script>
    const STORAGE_KEYS = {
        backend: "insight_summary_backend",
        transcribeModel: "insight_transcribe_model",
        asrEngine: "insight_asr_engine",
        summarizeModel: "insight_summarize_model",
        customApiUrl: "insight_custom_api_url",
        customApiModels: "insight_custom_api_models",
        translateBackend: "insight_translate_backend",
        translateModel: "insight_translate_model",
        translateTarget: "insight_translate_target",
        translateCustomApiUrl: "insight_translate_custom_api_url",
        translateCustomApiModels: "insight_translate_custom_api_models",
        pdfReflow: "insight_pdf_reflow",
        imageMode: "insight_image_translation_mode",
        translationMode: "insight_translation_mode"
    };

    const summaryBackendSelect = document.getElementById("summary_backend_selector");
    const customApiBlock = document.getElementById("custom_api_block");
    const customApiUrlInput = document.getElementById("custom_api_url");
    const customApiStatusEl = document.getElementById("custom_api_status");
    const customApiManualModelsBlock = document.getElementById("custom_api_manual_models");
    const customApiModelsManualInput = document.getElementById("custom_api_models_manual");
    let customApiModelsCache = []; // –ö–µ—à –º–æ–¥–µ–ª–µ–π –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ API
    const transcribeSelect = document.getElementById("transcribe_model");
    const summarizeSelect = document.getElementById("summarize_model");
    const targetLanguageSelect = document.getElementById("target_language");
    const translateModelSelect = document.getElementById("translate_model");
    const translateBackendSelect = document.getElementById("translate_backend_selector");
    const translateCustomApiBlock = document.getElementById("translate_custom_api_block");
    const translateCustomApiUrlInput = document.getElementById("translate_custom_api_url");
    const translateCustomApiStatusEl = document.getElementById("translate_custom_api_status");
    const translateCustomApiManualModelsBlock = document.getElementById("translate_custom_api_manual_models");
    const translateCustomApiModelsManualInput = document.getElementById("translate_custom_api_models_manual");
    let translateCustomApiModelsCache = []; // –ö–µ—à –º–æ–¥–µ–ª–µ–π –∏–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ API –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
    const pdfReflowCheckbox = document.getElementById("pdf_reflow");
    const imageModeSelect = document.getElementById("image_translation_mode");
    const translationModeSelect = document.getElementById("translation_mode");
    const summaryMetricsHint = document.getElementById("summary_metrics_hint");
    const translateMetricsHint = document.getElementById("translate_metrics_hint");
    let summarizerModelMetrics = {};
    let translateModelMetrics = {};

    function showNotify(msg, error=false, traceback=null, persistent=false) {
        var notif = document.getElementById('notify');
        notif.innerHTML = '';
        var msgSpan = document.createElement('span');
        msgSpan.textContent = msg;
        notif.appendChild(msgSpan);
        if (traceback) {
            var details = document.createElement('details');
            details.style.marginTop = '8px';
            details.style.fontSize = '11px';
            var summary = document.createElement('summary');
            summary.textContent = '–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)';
            summary.style.cursor = 'pointer';
            var pre = document.createElement('pre');
            pre.style.whiteSpace = 'pre-wrap';
            pre.style.fontSize = '10px';
            pre.textContent = traceback;
            details.appendChild(summary);
            details.appendChild(pre);
            notif.appendChild(details);
            summary.onclick = function(e) {
                e.stopPropagation();
                navigator.clipboard.writeText(traceback).then(() => {
                    summary.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => summary.textContent = '–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (–Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)', 2000);
                });
            };
        }
        var copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
        copyBtn.onclick = function(e) {
            e.stopPropagation();
            var textToCopy = traceback ? msg + '\n\n' + traceback : msg;
            navigator.clipboard.writeText(textToCopy).then(() => {
                copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => copyBtn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
            });
        };
        notif.appendChild(copyBtn);
        var closeBtn = document.createElement('button');
        closeBtn.className = 'close-btn';
        closeBtn.textContent = '‚úï';
        closeBtn.onclick = function(e) {
            e.stopPropagation();
            notif.style.display = 'none';
        };
        notif.appendChild(closeBtn);
        notif.className = 'notify'+(error?' error':'');
        notif.style.display='block';
        if (!error && !persistent) {
        setTimeout(() => notif.style.display='none', 4000);
        }
    }

    function buildMetricsMap(items){
        const map = {};
        items.forEach(item => {
            if(item.metrics){
                map[item.name] = item.metrics;
            }
        });
        return map;
    }

    function updateLLMMetricLabels(){
        if(summaryMetricsHint && summarizerModelMetrics && summarizeSelect){
            const summaryMetrics = summarizerModelMetrics[summarizeSelect.value];
            summaryMetricsHint.textContent = formatMetrics(summaryMetrics) || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏.";
        }
        if(translateMetricsHint && translateModelSelect){
            const translateMetrics = translateModelMetrics[translateModelSelect.value];
            translateMetricsHint.textContent = formatMetrics(translateMetrics) || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏.";
        }
    }

    function formatMetrics(metrics){
        if(!metrics){
            return null;
        }
        const parts = [];
        if(typeof metrics.ttft === "number"){
            parts.push(`TTFT ${metrics.ttft.toFixed(2)}—Å`);
        }
        if(typeof metrics.tpot_ms === "number"){
            parts.push(`TPOT ${metrics.tpot_ms.toFixed(0)}–º—Å`);
        }
        if(typeof metrics.throughput === "number"){
            parts.push(`${metrics.throughput.toFixed(1)} —Ç–æ–∫/—Å`);
        }
        return parts.join(" ¬∑ ");
    }

    function getLLMEstimate(scope){
        const map = scope === 'summarize' ? summarizerModelMetrics : translateModelMetrics;
        const selectEl = scope === 'summarize' ? summarizeSelect : translateModelSelect;
        if(!selectEl || !map){
            return null;
        }
        const metrics = map[selectEl.value];
        if(!metrics || !metrics.throughput || metrics.throughput <= 0){
            return null;
        }
        const tokens = metrics.avg_eval_count || 400;
        const ttft = typeof metrics.ttft === "number" ? metrics.ttft : 0;
        return Math.max(ttft + (tokens / metrics.throughput), 1);
    }

    function updateDownloadButton(selectId, buttonId, type) {
        const select = document.getElementById(selectId);
        const btn = document.getElementById(buttonId);
        if (!select || !btn) return;
        const selectedOption = select.options[select.selectedIndex];
        if (!selectedOption) return;
        const downloadedAttr = selectedOption.getAttribute('data-downloaded');
        const isDownloaded = String(downloadedAttr).toLowerCase() === 'true';
        btn.style.display = isDownloaded ? 'none' : 'block';
        if(!isDownloaded){
            const modelName = selectedOption.textContent.split(' (')[0];
            btn.textContent = '–°–∫–∞—á–∞—Ç—å ' + modelName;
        } else {
            btn.textContent = '–°–∫–∞—á–∞—Ç—å';
        }
    }

    function downloadSelectedModel(type) {
        const selectId = type === 'transcribe' ? 'transcribe_model'
            : type === 'summarize' ? 'summarize_model'
            : type === 'translate' ? 'translate_model' : null;
        if(!selectId) return;
        const select = document.getElementById(selectId);
        if (!select) return;
        const modelName = select.value;
        downloadModel(modelName, type === 'translate' ? 'summarize' : type);
    }

    function downloadModel(name, type) {
        showNotify('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ '+name+'... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.', false, null, true);
        var progressBar = document.getElementById('progress-bar');
        var progressValue = document.getElementById('progress-value');
        progressBar.style.display='block';
        progressValue.style.width='10%';
        
        // –î–ª—è –º–æ–¥–µ–ª–µ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        if(type === 'transcribe'){
            var progressInterval = setInterval(function(){
                var current = parseInt(progressValue.style.width) || 10;
                if(current < 90){
                    progressValue.style.width = (current + 5) + '%';
                }
            }, 2000);
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/download_model", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onprogress=function(e){
            if(e.lengthComputable){
                var percent = Math.floor(100*e.loaded/e.total);
                progressValue.style.width=percent+"%";
            }
        };
        xhr.onload = function(){
            if(type === 'transcribe'){
                clearInterval(progressInterval);
            }
            progressValue.style.width="100%";
            setTimeout(function(){
                progressBar.style.display='none';
                progressValue.style.width="0%";
            }, 500);
            try {
                var data = JSON.parse(xhr.responseText);
                if(data.status=="OK") {
                    showNotify("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–∞!");
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
                    if(type === 'transcribe'){
                        localStorage.setItem(STORAGE_KEYS.transcribeModel, name);
                    } else if(type === 'summarize'){
                        localStorage.setItem(STORAGE_KEYS.summarizeModel, name);
                    } else if(type === 'translate'){
                        localStorage.setItem(STORAGE_KEYS.translateModel, name);
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    loadModelOptions();
                } else {
                    showNotify("–û—à–∏–±–∫–∞: "+(data.message||"–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å"), true, data.traceback || null, true);
                }
            } catch(e){
                showNotify("–°–±–æ–π —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–∏: " + e.message, true, null, true);
            }
        };
        xhr.onerror = function(){
            if(type === 'transcribe'){
                clearInterval(progressInterval);
            }
            progressBar.style.display='none';
            progressValue.style.width="0%";
            showNotify("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É!", true, null, true);
        };
        xhr.send("model_name="+encodeURIComponent(name)+"&model_type="+encodeURIComponent(type));
    }

    function ensureOption(selectEl, value){
        if(!value) return;
        const exists = Array.from(selectEl.options).some(opt => opt.value === value);
        if(!exists){
            const opt = document.createElement("option");
            opt.value = value;
            opt.textContent = value.toUpperCase();
            selectEl.appendChild(opt);
        }
    }

    function populateSelect(selectEl, items, storageKey, scope){
        if (!selectEl) return;
        const saved = localStorage.getItem(storageKey);
        const currentValue = selectEl.value || saved; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ
        selectEl.innerHTML = "";
        items.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.name;
            opt.setAttribute('data-downloaded', item.downloaded ? 'true' : 'false');
            if(scope && item.metrics){
                opt.dataset.metrics = JSON.stringify(item.metrics);
            }
            if(scope && item.metrics_summary){
                opt.dataset.metricsSummary = item.metrics_summary;
            }
            let label = `${item.display_name} ${item.downloaded ? "(—Å–∫–∞—á–∞–Ω–æ)" : "(—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)"}`;
            if(scope && item.metrics_summary){
                label += ` ‚Äî ${item.metrics_summary}`;
            }
            opt.textContent = label;
            selectEl.appendChild(opt);
        });
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –ø–æ—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ, –ø–æ—Ç–æ–º –ø–µ—Ä–≤—É—é
        const preferred = (currentValue && items.find(i => i.name === currentValue)) 
            ? currentValue 
            : (saved && items.find(i => i.name === saved)) 
                ? saved 
                : (items[0]?.name || "");
        if (preferred) {
            selectEl.value = preferred;
            localStorage.setItem(storageKey, preferred);
        }
        if(scope === 'summarize'){
            summarizerModelMetrics = buildMetricsMap(items);
        } else if(scope === 'translate'){
            translateModelMetrics = buildMetricsMap(items);
        }
        if(scope){
            updateLLMMetricLabels();
        }
    }

    function updateDownloadButtonsForType(type) {
        if (type === 'transcribe') {
            updateDownloadButton('transcribe_model', 'transcribe_download_btn', 'transcribe');
        } else if (type === 'summarize') {
            updateDownloadButton('summarize_model', 'summarize_download_btn', 'summarize');
        } else if (type === 'translate') {
            updateDownloadButton('translate_model', 'translate_download_btn', 'translate');
        }
    }

    function applyBackendState(){
        const backend = summaryBackendSelect.value;
        summaryBackendSelect.value = backend;
        const isSummaryEnabled = enableSummaryCheckbox ? enableSummaryCheckbox.checked : false;
        if (customApiBlock) {
            customApiBlock.style.display = (backend === "custom_api" && isSummaryEnabled) ? "block" : "none";
        }
        localStorage.setItem(STORAGE_KEYS.backend, backend);
        loadModelOptions();
    }

    async function checkCustomApi(scope){
        const isTranslate = scope === 'translate';
        const urlInput = isTranslate ? translateCustomApiUrlInput : customApiUrlInput;
        const statusEl = isTranslate ? translateCustomApiStatusEl : customApiStatusEl;
        const manualBlock = isTranslate ? translateCustomApiManualModelsBlock : customApiManualModelsBlock;
        const manualInput = isTranslate ? translateCustomApiModelsManualInput : customApiModelsManualInput;
        const url = urlInput.value.trim();
        
        if(!url){
            if(statusEl) statusEl.textContent = '–£–∫–∞–∂–∏—Ç–µ URL API';
            if(manualBlock) manualBlock.style.display = 'none';
            return;
        }
        
        if(statusEl) statusEl.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
        if(manualBlock) manualBlock.style.display = 'none';
        const formData = new FormData();
        formData.append('api_url', url);
        formData.append('scope', scope);
        
        try{
            const resp = await fetch('/api/check_custom_api', {method: 'POST', body: formData});
            const data = await resp.json();
            
            if(data.status === 'success' || data.status === 'connected'){
                if(data.models && data.models.length > 0){
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–æ–¥–µ–ª–∏ –≤ –∫–µ—à
                    if(isTranslate){
                        translateCustomApiModelsCache = data.models.map(m => m.name);
                    } else {
                        customApiModelsCache = data.models.map(m => m.name);
                    }
                    if(statusEl) statusEl.textContent = `‚úì ${data.message || `–ù–∞–π–¥–µ–Ω–æ –º–æ–¥–µ–ª–µ–π: ${data.models.length}`}`;
                    if(statusEl) statusEl.style.color = '#0a0';
                    if(manualBlock) manualBlock.style.display = 'none';
                } else {
                    // API –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞
                    if(statusEl) statusEl.textContent = data.message || 'API –¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–æ –º–æ–¥–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    if(statusEl) statusEl.style.color = '#ff8800';
                    if(manualBlock) manualBlock.style.display = 'block';
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏ –∏–∑ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if(manualInput && manualInput.value.trim()){
                        const manualModels = manualInput.value.split(',').map(m => m.trim()).filter(m => m);
                        if(manualModels.length > 0){
                            if(isTranslate){
                                translateCustomApiModelsCache = manualModels;
                            } else {
                                customApiModelsCache = manualModels;
                            }
                        }
                    }
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π
                loadModelOptions();
            } else {
                if(statusEl) statusEl.textContent = `‚úó ${data.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}`;
                if(statusEl) statusEl.style.color = '#c00';
                if(manualBlock) manualBlock.style.display = 'none';
            }
        } catch(e){
            if(statusEl) statusEl.textContent = `‚úó –û—à–∏–±–∫–∞: ${e.message}`;
            if(statusEl) statusEl.style.color = '#c00';
            if(manualBlock) manualBlock.style.display = 'none';
        }
    }

    function loadModelOptions(){
        const backend = summaryBackendSelect.value;
        const translateBackend = translateBackendSelect ? translateBackendSelect.value : 'ollama';
        const params = new URLSearchParams();
        params.append("summary_backend", backend);
        if(backend === "custom_api" && customApiModelsCache.length > 0){
            params.append("custom_models", customApiModelsCache.join(','));
        }
        params.append("translate_backend", translateBackend);
        if(translateBackend === "custom_api" && translateCustomApiModelsCache.length > 0){
            params.append("translate_custom_models", translateCustomApiModelsCache.join(','));
        }
        fetch(`/list_models?${params.toString()}`)
            .then(resp => resp.json())
            .then(data => {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                const currentTranscribe = transcribeSelect ? transcribeSelect.value : null;
                const currentSummarize = summarizeSelect ? summarizeSelect.value : null;
                const currentTranslate = translateModelSelect ? translateModelSelect.value : null;
                const currentReview = document.getElementById('review_model') ? document.getElementById('review_model').value : null;
                
                populateSelect(transcribeSelect, data.transcribe || [], STORAGE_KEYS.transcribeModel);
                populateSelect(summarizeSelect, data.summarize || [], STORAGE_KEYS.summarizeModel, 'summarize');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–∫–∂–µ –º–æ–¥–µ–ª—å —Ä–µ–≤—å—é —Ç–µ–º–∏ –∂–µ –º–æ–¥–µ–ª—è–º–∏
                const reviewSelect = document.getElementById('review_model');
                if(reviewSelect){
                    reviewSelect.innerHTML = '<option value="">‚Äî –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ‚Äî</option>';
                    (data.summarize || []).forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.name;
                        opt.setAttribute('data-downloaded', item.downloaded ? 'true' : 'false');
                        let label = `${item.display_name} ${item.downloaded ? "(—Å–∫–∞—á–∞–Ω–æ)" : "(—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å)"}`;
                        if(item.metrics_summary){
                            label += ` ‚Äî ${item.metrics_summary}`;
                        }
                        opt.textContent = label;
                        reviewSelect.appendChild(opt);
                    });
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å —Ä–µ–≤—å—é
                    if(currentReview && Array.from(reviewSelect.options).some(opt => opt.value === currentReview)){
                        reviewSelect.value = currentReview;
                    }
                }
                
                if(translateModelSelect && data.translate){
                    populateSelect(translateModelSelect, data.translate || [], STORAGE_KEYS.translateModel, 'translate');
                }
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã
                if(currentTranscribe && transcribeSelect && Array.from(transcribeSelect.options).some(opt => opt.value === currentTranscribe)){
                    transcribeSelect.value = currentTranscribe;
                    localStorage.setItem(STORAGE_KEYS.transcribeModel, currentTranscribe);
                }
                if(currentSummarize && summarizeSelect && Array.from(summarizeSelect.options).some(opt => opt.value === currentSummarize)){
                    summarizeSelect.value = currentSummarize;
                    localStorage.setItem(STORAGE_KEYS.summarizeModel, currentSummarize);
                }
                if(currentTranslate && translateModelSelect && Array.from(translateModelSelect.options).some(opt => opt.value === currentTranslate)){
                    translateModelSelect.value = currentTranslate;
                    localStorage.setItem(STORAGE_KEYS.translateModel, currentTranslate);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π
                updateDownloadButtonsForType('transcribe');
                updateDownloadButtonsForType('summarize');
                updateDownloadButtonsForType('translate');
                updateLLMMetricLabels();
            })
            .catch(() => showNotify("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π", true));
    }

    function applyTranslateBackendState(){
        if(!translateBackendSelect) return;
        const backend = translateBackendSelect.value;
        if(translateCustomApiBlock){
            translateCustomApiBlock.style.display = backend === "custom_api" ? "block" : "none";
        }
        localStorage.setItem(STORAGE_KEYS.translateBackend, backend);
        loadModelOptions();
    }

    function restoreSettings(){
        const savedBackend = localStorage.getItem(STORAGE_KEYS.backend) || "{{config.SUMMARY_BACKEND}}";
        summaryBackendSelect.value = savedBackend;
        customApiUrlInput.value = localStorage.getItem(STORAGE_KEYS.customApiUrl) || "";
        customApiBlock.style.display = savedBackend === "custom_api" ? "block" : "none";
        populateSelect(transcribeSelect, {{ model_options.transcribe | tojson }}, STORAGE_KEYS.transcribeModel);
        populateSelect(summarizeSelect, {{ model_options.summarize | tojson }}, STORAGE_KEYS.summarizeModel, 'summarize');
        updateDownloadButtonsForType('transcribe');
        updateDownloadButtonsForType('summarize');
        if(asrEngineSelect){
            const savedEngine = localStorage.getItem(STORAGE_KEYS.asrEngine) || "auto";
            asrEngineSelect.value = savedEngine;
            updateAsrEngineUI();
        }
        const defaultLang = "{{config.TRANSLATION_TARGET_LANG}}";
        ensureOption(targetLanguageSelect, defaultLang);
        const savedLang = localStorage.getItem(STORAGE_KEYS.translateTarget) || defaultLang;
        ensureOption(targetLanguageSelect, savedLang);
        targetLanguageSelect.value = savedLang;
        if(translateBackendSelect){
            const savedTranslateBackend = localStorage.getItem(STORAGE_KEYS.translateBackend) || "ollama";
            translateBackendSelect.value = savedTranslateBackend;
            if(translateCustomApiUrlInput){
                translateCustomApiUrlInput.value = localStorage.getItem(STORAGE_KEYS.translateCustomApiUrl) || "";
            }
            if(translateCustomApiBlock){
                translateCustomApiBlock.style.display = savedTranslateBackend === "custom_api" ? "block" : "none";
            }
        }
        if(translateModelSelect){
            populateSelect(translateModelSelect, {{ model_options.translate | tojson }}, STORAGE_KEYS.translateModel, 'translate');
            updateDownloadButtonsForType('translate');
        }
        if(pdfReflowCheckbox){
            const savedPdfReflow = localStorage.getItem(STORAGE_KEYS.pdfReflow);
            const defaultPdf = {{ 'true' if config.DEFAULT_PDF_REFLOW else 'false' }};
            pdfReflowCheckbox.checked = savedPdfReflow ? savedPdfReflow === "on" : defaultPdf;
        }
        if(imageModeSelect){
            const savedMode = localStorage.getItem(STORAGE_KEYS.imageMode) || "{{config.DEFAULT_IMAGE_TRANSLATION_MODE}}";
            imageModeSelect.value = savedMode;
        }
        if(translationModeSelect){
            const savedTranslationMode = localStorage.getItem(STORAGE_KEYS.translationMode) || "{{config.DEFAULT_TRANSLATION_MODE}}";
            translationModeSelect.value = savedTranslationMode;
        }
        updateLLMMetricLabels();
        setTimeout(loadModelOptions, 100);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ custom API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ URL —Å–æ—Ö—Ä–∞–Ω–µ–Ω
        if(summaryBackendSelect && summaryBackendSelect.value === "custom_api" && customApiUrlInput && customApiUrlInput.value.trim()){
            setTimeout(() => checkCustomApi('summarize'), 200);
        }
        if(translateBackendSelect && translateBackendSelect.value === "custom_api" && translateCustomApiUrlInput && translateCustomApiUrlInput.value.trim()){
            setTimeout(() => checkCustomApi('translate'), 300);
        }
    }

    summaryBackendSelect.addEventListener("change", applyBackendState);
    customApiUrlInput.addEventListener("blur", () => {
        localStorage.setItem(STORAGE_KEYS.customApiUrl, customApiUrlInput.value);
        if(summaryBackendSelect.value === "custom_api" && customApiUrlInput.value.trim()){
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
            checkCustomApi('summarize');
        }
    });
    if(customApiModelsManualInput){
        customApiModelsManualInput.addEventListener("input", () => {
            const models = customApiModelsManualInput.value.split(',').map(m => m.trim()).filter(m => m);
            if(models.length > 0){
                customApiModelsCache = models;
                loadModelOptions();
            }
        });
    }
    transcribeSelect.addEventListener("change", () => {
        localStorage.setItem(STORAGE_KEYS.transcribeModel, transcribeSelect.value);
        updateDownloadButtonsForType('transcribe');
        if (asrEngineSelect) updateAsrEngineUI();
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –¥–≤–∏–∂–∫–∞ ASR
    if (asrEngineSelect) {
        asrEngineSelect.addEventListener("change", () => {
            localStorage.setItem(STORAGE_KEYS.asrEngine, asrEngineSelect.value);
            updateAsrEngineUI();
        });
    }
    summarizeSelect.addEventListener("change", () => {
        localStorage.setItem(STORAGE_KEYS.summarizeModel, summarizeSelect.value);
        updateDownloadButtonsForType('summarize');
        updateLLMMetricLabels();
    });
    if(translateBackendSelect){
        translateBackendSelect.addEventListener("change", applyTranslateBackendState);
    }
    if(translateCustomApiUrlInput){
        translateCustomApiUrlInput.addEventListener("blur", () => {
            localStorage.setItem(STORAGE_KEYS.translateCustomApiUrl, translateCustomApiUrlInput.value);
            if(translateBackendSelect && translateBackendSelect.value === "custom_api" && translateCustomApiUrlInput.value.trim()){
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
                checkCustomApi('translate');
            }
        });
    }
    if(translateCustomApiModelsManualInput){
        translateCustomApiModelsManualInput.addEventListener("input", () => {
            const models = translateCustomApiModelsManualInput.value.split(',').map(m => m.trim()).filter(m => m);
            if(models.length > 0){
                translateCustomApiModelsCache = models;
                loadModelOptions();
            }
        });
    }
    if(pdfReflowCheckbox){
        pdfReflowCheckbox.addEventListener("change", () => {
            localStorage.setItem(STORAGE_KEYS.pdfReflow, pdfReflowCheckbox.checked ? "on" : "off");
        });
    }
    if(imageModeSelect){
        imageModeSelect.addEventListener("change", () => {
            localStorage.setItem(STORAGE_KEYS.imageMode, imageModeSelect.value);
        });
    }
    if(translationModeSelect){
        translationModeSelect.addEventListener("change", () => {
            localStorage.setItem(STORAGE_KEYS.translationMode, translationModeSelect.value);
        });
    }
    if(translateModelSelect){
        translateModelSelect.addEventListener("change", () => {
            localStorage.setItem(STORAGE_KEYS.translateModel, translateModelSelect.value);
            updateDownloadButtonsForType('translate');
            updateLLMMetricLabels();
        });
    }

    targetLanguageSelect.addEventListener("change", () => {
        localStorage.setItem(STORAGE_KEYS.translateTarget, targetLanguageSelect.value);
    });

    restoreSettings();

    
    </script>
    <script>
    // Lightweight override for SSE-based flows
    const tabs = document.querySelectorAll('.tab-btn');
    const sections = document.querySelectorAll('.tab-section');
    function switchTab(tabId){
        tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabId));
        sections.forEach(sec => sec.style.display = sec.id === tabId ? 'block' : 'none');
        if(tabId === 'jobsTab'){ loadJobs(); }
    }

    const enableSummaryCheckbox = document.getElementById("enable_summary");
    const enableTranslationCheckbox = document.getElementById("enable_translation");
    const targetLanguageAudioSelect = document.getElementById("target_language_audio");
    const audioLanguageSelect = document.getElementById("audio_language");
    const presetSelect = document.getElementById("preset");
    const enableDiarizationCheckbox = document.getElementById("enable_diarization");
    const beamSizeInput = document.getElementById("beam_size");
    const temperatureInput = document.getElementById("temperature");
    const vadFilterSelect = document.getElementById("vad_filter");
    const noSpeechThresholdInput = document.getElementById("no_speech_threshold");
    const asrEngineSelect = document.getElementById("asr_engine");
    const asrEngineHint = document.getElementById("asr_engine_hint");
    const vadFilterBadge = document.getElementById("vad_filter_badge");
    const vadFilterHint = document.getElementById("vad_filter_hint");
    const audioJobStatusEl = document.getElementById("audioJobStatus");
    const docJobStatusEl = document.getElementById("docJobStatus");
    const jobsListEl = document.getElementById("jobsList");
    const promptTemplateSelect = document.getElementById("prompt_template");
    const customPromptTextarea = document.getElementById("custom_prompt");
    const jobStreams = new Map();

    if(promptTemplateSelect && customPromptTextarea){
        promptTemplateSelect.addEventListener("change", () => {
            const selected = promptTemplateSelect.options[promptTemplateSelect.selectedIndex];
            const text = selected ? selected.getAttribute("data-text") : "";
            if(text){
                customPromptTextarea.value = text;
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è/–ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–æ–≤ –ø–µ—Ä–µ—Å–∫–∞–∑–∞
    function toggleSummaryBlocks() {
        const isEnabled = enableSummaryCheckbox ? enableSummaryCheckbox.checked : false;
        const summaryBlocks = document.getElementById("summary_blocks");
        const customApiBlock = document.getElementById("custom_api_block");
        const summaryModelBlock = document.getElementById("summary_model_block");
        const reviewModelBlock = document.getElementById("review_model_block");
        const reviewPromptBlock = document.getElementById("review_prompt_block");
        const promptTemplateBlock = document.getElementById("prompt_template_block");
        
        if (summaryBlocks) summaryBlocks.style.display = isEnabled ? "block" : "none";
        if (customApiBlock) {
            const summaryBackendSelect = document.getElementById("summary_backend_selector");
            customApiBlock.style.display = isEnabled && summaryBackendSelect && summaryBackendSelect.value === "custom_api" ? "block" : "none";
        }
        if (summaryModelBlock) summaryModelBlock.style.display = isEnabled ? "block" : "none";
        if (reviewModelBlock) reviewModelBlock.style.display = isEnabled ? "block" : "none";
        // –ë–ª–æ–∫ –ø—Ä–æ–º–ø—Ç–∞ —Ä–µ–≤—å—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å —Ä–µ–≤—å—é
        if (reviewPromptBlock) {
            const reviewModel = document.getElementById("review_model");
            reviewPromptBlock.style.display = isEnabled && reviewModel && reviewModel.value ? "block" : "none";
        }
        if (promptTemplateBlock) promptTemplateBlock.style.display = isEnabled ? "block" : "none";
    }
    
    if (enableSummaryCheckbox) {
        enableSummaryCheckbox.addEventListener("change", toggleSummaryBlocks);
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(toggleSummaryBlocks, 100);
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ –±–ª–æ–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ —Ä–µ–≤—å—é –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–¥–µ–ª–∏
    const reviewModelSelect = document.getElementById("review_model");
    const reviewPromptBlock = document.getElementById("review_prompt_block");
    const reviewPromptTemplateSelect = document.getElementById("review_prompt_template");
    const reviewCustomPromptTextarea = document.getElementById("review_custom_prompt");
    
    if (reviewModelSelect && reviewPromptBlock) {
        reviewModelSelect.addEventListener("change", () => {
            const hasReviewModel = reviewModelSelect.value && enableSummaryCheckbox && enableSummaryCheckbox.checked;
            reviewPromptBlock.style.display = hasReviewModel ? "block" : "none";
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞ —Ä–µ–≤—å—é
    if (reviewPromptTemplateSelect && reviewCustomPromptTextarea) {
        reviewPromptTemplateSelect.addEventListener("change", () => {
            const selected = reviewPromptTemplateSelect.options[reviewPromptTemplateSelect.selectedIndex];
            const text = selected ? selected.getAttribute("data-text") : "";
            if (text) {
                reviewCustomPromptTextarea.value = text;
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–≤–∏–∂–∫–∞ ASR
    function enforceAsrCompatibility() {
        if (!asrEngineSelect) return;
        const modelSelect = document.getElementById("transcribe_model");
        const modelName = modelSelect ? modelSelect.value : "";
        const engine = asrEngineSelect.value;
        // faster-whisper –º–æ–¥–µ–ª–∏ –Ω–µ–ª—å–∑—è –∑–∞–ø—É—Å–∫–∞—Ç—å —á–µ—Ä–µ–∑ openai_whisper
        if (modelName.startsWith("faster-whisper") && engine === "openai_whisper") {
            asrEngineSelect.value = "faster_whisper";
            showNotify("–î–ª—è faster-whisper –≤—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∏–∂–æ–∫ Faster-Whisper –∏–ª–∏ Auto", true);
        }
    }

    function updateAsrEngineUI() {
        if (!asrEngineSelect) return;
        
        const engine = asrEngineSelect.value;
        const modelSelect = document.getElementById("transcribe_model");
        const modelName = modelSelect ? modelSelect.value : "";
        enforceAsrCompatibility();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        if (asrEngineHint) {
            if (engine === "auto") {
                const isFasterModel = modelName.startsWith("faster-whisper");
                const isWhisperModel = modelName.startsWith("whisper");
                if (isFasterModel) {
                    asrEngineHint.textContent = "Auto –≤—ã–±–µ—Ä–µ—Ç faster-whisper –¥–ª—è —ç—Ç–æ–π –º–æ–¥–µ–ª–∏";
                } else if (isWhisperModel) {
                    asrEngineHint.textContent = "Auto –≤—ã–±–µ—Ä–µ—Ç faster-whisper (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ openai-whisper";
                } else {
                    asrEngineHint.textContent = "Auto –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–µ—Ä–µ—Ç –ª—É—á—à–∏–π –¥–≤–∏–∂–æ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏";
                }
            } else if (engine === "faster_whisper") {
                asrEngineHint.textContent = "üü© Faster-Whisper —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: –±—ã—Å—Ç—Ä–µ–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç VAD filter";
            } else if (engine === "openai_whisper") {
                asrEngineHint.textContent = "üü® OpenAI Whisper (legacy): VAD filter –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è";
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å vad_filter
        const vadSupported = engine === "faster_whisper" || (engine === "auto" && modelName.startsWith("faster-whisper"));
        if (vadFilterSelect) {
            vadFilterSelect.disabled = !vadSupported;
            if (vadSupported) {
                vadFilterSelect.style.opacity = "1";
            } else {
                vadFilterSelect.style.opacity = "0.5";
            }
        }
        if (vadFilterBadge) {
            if (vadSupported) {
                vadFilterBadge.textContent = "(faster-whisper)";
                vadFilterBadge.style.color = "#0a0";
            } else {
                vadFilterBadge.textContent = "(—Ç–æ–ª—å–∫–æ faster-whisper)";
                vadFilterBadge.style.color = "#c00";
            }
        }
        if (vadFilterHint) {
            if (vadSupported) {
                vadFilterHint.style.display = "none";
            } else {
                vadFilterHint.style.display = "block";
            }
        }
    }
    
    if (asrEngineSelect) {
        asrEngineSelect.addEventListener("change", updateAsrEngineUI);
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏
        const transcribeSelect = document.getElementById("transcribe_model");
        if (transcribeSelect) {
            transcribeSelect.addEventListener("change", () => {
                enforceAsrCompatibility();
                updateAsrEngineUI();
            });
        }
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => {
            enforceAsrCompatibility();
            updateAsrEngineUI();
        }, 100);
    }

    function formatDateTime(value){
        if(!value) return '‚Äî';
        try {
            const d = new Date(value);
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            return new Intl.DateTimeFormat(undefined, {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hourCycle: 'h23',
                timeZone: tz,
                timeZoneName: 'short'
            }).format(d);
        } catch(e){
            return value;
        }
    }

    function makeJobCard(job){
        const statusColor = job.status === 'success' ? '#0a0' : job.status === 'failed' ? '#c00' : '#0059b2';
        const manifest = (job.result_manifest || []).map(item => {
            const url = `/api/jobs/${job.id}/download/${encodeURIComponent(item.name)}`;
            return `<a href="${url}" class="btn" download>${item.kind || item.name}</a>`;
        }).join(' ');
        const err = job.error_message ? `<div style="color:#c00;font-size:13px;">${job.error_message}</div>` : '';
        const eta = job.eta_seconds != null ? `ETA: ~${Math.ceil(job.eta_seconds)} c` : '';
        const created = formatDateTime(job.created_at);
        const started = formatDateTime(job.started_at);
        const finished = formatDateTime(job.finished_at);
        const canCancel = !['success','failed','canceled'].includes(job.status);
        const cancelBtn = canCancel ? `<button class="download-btn" style="margin-left:8px;" type="button" onclick="cancelJob('${job.id}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : '';
        return `
            <div class="file-block">
                <div><b>ID:</b> ${job.id}</div>
                <div><b>–¢–∏–ø:</b> ${job.job_type}</div>
                <div><b>–°—Ç–∞—Ç—É—Å:</b> <span style="color:${statusColor}">${job.status}</span> ¬∑ —Å—Ç–∞–¥–∏—è: ${job.stage} ¬∑ –ø—Ä–æ–≥—Ä–µ—Å—Å: ${job.progress}% ${eta} ${cancelBtn}</div>
                <div class="small"><b>–°–æ–∑–¥–∞–Ω–∞:</b> ${created} ¬∑ <b>–ù–∞—á–∞—Ç–∞:</b> ${started} ¬∑ <b>–ó–∞–≤–µ—Ä—à–µ–Ω–∞:</b> ${finished}</div>
                ${manifest ? `<div style="margin-top:8px;">${manifest}</div>` : ''}
                ${err}
            </div>
        `;
    }

    function renderJobs(jobs){
        if(!jobsListEl) return;
        if(!jobs || jobs.length === 0){
            jobsListEl.innerHTML = '<p class="small">–ó–∞–¥–∞–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
            return;
        }
        jobsListEl.innerHTML = jobs.map(makeJobCard).join('');
    }

    async function cancelJob(jobId){
        try{
            const resp = await fetch(`/api/jobs/${jobId}/cancel`, {method: 'POST'});
            if(!resp.ok){
                showNotify('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É', true);
                return;
            }
            const data = await resp.json();
            showNotify(`–ó–∞–¥–∞—á–∞ ${jobId} –æ—Ç–º–µ–Ω–µ–Ω–∞ (${data.status})`, false, null, true);
            loadJobs();
        }catch(e){
            showNotify('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–¥–∞—á–∏: '+e.message, true);
        }
    }

    async function loadJobs(){
        try{
            const resp = await fetch('/api/jobs');
            const data = await resp.json();
            renderJobs(data);
        }catch(e){
            showNotify('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è', true);
        }
    }

    function trackJob(jobId, targetEl){
        if(jobStreams.has(jobId)){ return; }
        const es = new EventSource(`/api/jobs/${jobId}/events`);
        jobStreams.set(jobId, es);
        es.onmessage = (ev)=>{
            try{
                const job = JSON.parse(ev.data);
                if(targetEl){ targetEl.innerHTML = makeJobCard(job); }
            }catch(_){}
        };
        es.onerror = ()=> {
            es.close();
            jobStreams.delete(jobId);
        };
    }

    async function submitAudio(event){
        event.preventDefault();
        const fileInput = document.getElementById('file');
        if(!fileInput.files.length){ showNotify('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', true); return; }
        const params = {
            asr_model: document.getElementById('transcribe_model').value,
            asr_engine: asrEngineSelect ? asrEngineSelect.value : 'auto',
            language: audioLanguageSelect.value,
            preset: presetSelect.value,
            enable_diarization: enableDiarizationCheckbox.checked,
            beam_size: beamSizeInput.value ? Number(beamSizeInput.value) : undefined,
            temperature: temperatureInput.value ? Number(temperatureInput.value) : undefined,
            vad_filter: vadFilterSelect.value === "" ? undefined : vadFilterSelect.value === "true",
            no_speech_threshold: noSpeechThresholdInput.value ? Number(noSpeechThresholdInput.value) : undefined,
            enable_summary: enableSummaryCheckbox.checked,
            summary_model: document.getElementById('summarize_model').value,
            summary_backend: document.getElementById('summary_backend_selector').value,
            summary_custom_api_url: document.getElementById('custom_api_url').value || undefined,
            review_model: document.getElementById('review_model')?.value || undefined,
            review_prompt: document.getElementById('review_custom_prompt')?.value || undefined,
            prompt_template_id: document.getElementById('prompt_template').value || undefined,
            custom_prompt: document.getElementById('custom_prompt').value || undefined,
            enable_translation: enableTranslationCheckbox.checked,
            target_language: targetLanguageAudioSelect.value,
        };
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        fd.append('params', JSON.stringify(params));
        showNotify('–ó–∞–¥–∞—á–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞, –æ–∂–∏–¥–∞–π—Ç–µ...', false, null, true);
        const resp = await fetch('/api/jobs/audio', {method:'POST', body: fd});
        if(!resp.ok){
            showNotify('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞—á–∏', true);
            return;
        }
        const data = await resp.json();
        audioJobStatusEl.innerHTML = `<p class="small">Job ${data.job_id} —Å–æ–∑–¥–∞–Ω, –∂–¥—ë–º —Å–æ–±—ã—Ç–∏—è...</p>`;
        trackJob(data.job_id, audioJobStatusEl);
        loadJobs();
    }

    async function submitDoc(event){
        event.preventDefault();
        const fileInput = document.getElementById('doc_file');
        if(!fileInput.files.length){ showNotify('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', true); return; }
        const params = {
            target_language: document.getElementById('target_language').value,
            translate_model: document.getElementById('translate_model').value,
            translate_backend: document.getElementById('translate_backend_selector').value,
            translate_custom_api_url: document.getElementById('translate_custom_api_url') ? document.getElementById('translate_custom_api_url').value : undefined,
            translation_mode: document.getElementById('translation_mode').value,
            pdf_reflow: document.getElementById('pdf_reflow').checked,
            image_translation_mode: document.getElementById('image_translation_mode').value,
        };
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        fd.append('params', JSON.stringify(params));
        showNotify('–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –æ–∂–∏–¥–∞–π—Ç–µ...', false, null, true);
        const resp = await fetch('/api/jobs/doc_translate', {method:'POST', body: fd});
        if(!resp.ok){
            showNotify('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–¥–∞—á–∏', true);
            return;
        }
        const data = await resp.json();
        docJobStatusEl.innerHTML = `<p class="small">Job ${data.job_id} —Å–æ–∑–¥–∞–Ω, –∂–¥—ë–º —Å–æ–±—ã—Ç–∏—è...</p>`;
        trackJob(data.job_id, docJobStatusEl);
        loadJobs();
    }

    // Override old handlers with SSE-based ones
    document.getElementById('processForm').onsubmit = submitAudio;
    if(document.getElementById('translateForm')){
        document.getElementById('translateForm').onsubmit = submitDoc;
    }
    loadJobs();
    </script>
</body>
</html>
